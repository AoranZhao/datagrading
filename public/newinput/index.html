<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Input</title>
</head>
<style>
	html body div {
        margin: 0;
        padding: 0;
    }
    #latexdiv{
		margin: 0;
		padding: 0;
        top: 370px;
        position: absolute;
        float: left;
        height:467px;
        overflow: scroll;
        overflow-x:hidden;
        border:2px #000000 solid;
    }
    .btns{
        position: absolute;
        top:15px;
        width: 80px;
        background-color: white;
        border-radius: 2px;
    }
    textarea{
        background-color: aquamarine;
        font-size: 18px;
        resize: none;
		position: absolute;
		width: 263px;
    }
	#text{
		width: 1086px;
		height: 235px;
		left: 304px;
		top:600px;
		line-height: 1.5;
	}
	#checked{
		top:320px;
		height: 21px;
	}
	#note2{
        top:80px;
        height: 200px;
	}
	.layer_btn{
            position: absolute;
            width: 100px;
            height: 100px;
            top: 60px;
		 	left: 1200px;
        }
    .color{
            width:90px;
            margin-left: 2px;
        }
    .color_arrange{
            width: 190px;
            margin-bottom: 20px;

        }
    .canvas{
            position : absolute;
            left: 280px;
            top: 60px;
			height:500px;
			width:917px;
			overflow-y: scroll;
        }
    #arc{
            position: absolute;
            left:10000px;
            top:10000px;
            width:50px;
            height:50px;
            border-radius: 25px;
            border-width: 1px;
            background-color: rgba(0,0,0,0.4);
        }
	.layTex{
		    border-bottom:1px solid black;
		    margin: 0;padding: 0;
			width:64px;
			height: 16px;
			font-size: 12px;
			background-color: white;
		    text-align:center;
	}
</style>

<body>
	<div>
		<select class="btns" id="1" style="left:10px"></select>
		<select class="btns" id="2" style="left:90px"></select>
		<select class="btns" id="3" style="left:170px"></select>
		<button class="btns" id="Erase" style="left: 400px; background-color: white">擦除</button>
		<button class="btns" id="submit" style="left: 300px">提交文字</button></div>
	<button class="btns" id="rollback" style="left:500px ">撤销</button>
	<button class="btns" id="selectpage" style="left:650px ">换页</button>
	<input type="text" class="btns" id="inputpage" value="1" style="width: 38px; left:600px" />
	<input type="text" class="btns" id="alpha_input" value="1.0" style="width: 19px; left:750px" />
	<button class="btns" id="change_alpha" style="left:777px ">改变透明度</button>
	<br><span style="position: absolute;top: 570px; left:280px;font-size: 18px;">text_content:</span>
	<div id="left" style="top:602px;left: 280px;height: 235px;overflow-y: scroll;position: absolute;font-size : 18px;line-height: 1.5;">
		01<br>02<br>03<br>04<br>05<br>06<br>07<br>08<br>09<br>10<br>
		11<br> 12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>
		21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>
		31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>
		41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br></div>
	<textarea id="text"></textarea>
	<span style="position: absolute;top: 290px; font-size: 18px;">checked:</span>
	<div id="checked_btn">
		<button class="btns" id="true" style="position: absolute;top: 293px; left:100px; font-size: 14px;">true</button>
		<button class="btns" id="false" style="position: absolute;top: 293px; left:183px; font-size: 14px;">false</button>
	</div>
	<textarea id="checked"></textarea>
	<span style="position: absolute;top: 50px;font-size: 18px;">note2:</span>
	<textarea id="note2"></textarea>
	<div class="imgArea" id="latexdiv">
		<ul class="layText" style=" margin: 0; padding: 0;position:absolute; left:-10px; top: -84.7px;transform: scale(0.67);">
			<li class="layTex">\cdot</li>
			<li class="layTex">\cot</li>
			<li class="layTex">\cos</li>
			<li class="layTex">\tan</li>
			<li class="layTex">\sin</li>
			<li class="layTex">\geq</li>
			<li class="layTex">\leq</li>
			<li class="layTex">\sim</li>
			<li class="layTex">\beta</li>
			<li class="layTex">\alpha</li>
			<li class="layTex">\theta</li>
			<li class="layTex">\%</li>
			<li class="layTex">\pi</li>
			<li class="layTex">\prime</li>
			<li class="layTex">\cong</li>
			<li class="layTex" style="height: 25px">\pm</li>
			<li class="layTex">\neq</li>
			<li class="layTex">\div</li>
			<li class="layTex">\times</li>
			<li class="layTex">\because</li>
			<li class="layTex">\therefore</li>
			<li class="layTex">\Delta</li>
			<li class="layTex">\angle</li>
			<li class="layTex">\sqrt</li>
			<li class="layTex">\vec</li>
			<li class="layTex">\perp</li>
			<li class="layTex">\circ</li>
			<li class="layTex">_</li>
			<li class="layTex">^</li>
			<li class="layTex">\hat</li>
			<li class="layTex">\arc</li>
			<li class="layTex">\frac</li>
			<li class="layTex">\cdots</li>
			<li class="layTex">\odot</li>
			<li class="layTex">\parallel</li>
			<li class="layTex">\approx</li>
			<li class="layTex">\bar</li>
			<li class="layTex">\gamma</li>
		</ul>
		<img src="image/LaTeX说明1.png" style="width: 250px" />
	</div>
	<div id="arc" style="pointer-events:none"></div>
	<div class="layer_btn">
		<div class="color_arrange">
			<button class="color display" id="display_printed">显示打印层</button>
			<button class="color save" id="printed_save">保存打印层</button>
		</div>
		<div class="color_arrange">
			<button class="color display" id="display_written">显示手写层</button>
			<button class="color save" id="written_save">保存手写层</button>
		</div>
		<div class="color_arrange">
			<button class="color display" id="display_picture">显示图片层</button>
			<button class="color save" id="picture_save">保存图片层</button>
		</div>
		<div class="color_arrange">
			<button class="color display" id="display_labeling">显示标记层</button>
			<button class="color save" id="labeling_save">保存标记层</button>
		</div>
		<div class="color_arrange">
			<select style="width:90px" class="color display" id="select">
				<option value="c1_save">1</option>
				<option value="c2_save">2</option>
				<option value="c3_save">3</option>
				<option value="c4_save">4</option>
				<option value="c5_save">5</option>
				<option value="c6_save">6</option>
				<option value="c7_save">7</option>
				<option value="c8_save">8</option>
				<option value="c9_save">9</option>
				<option value="c10_save">10</option>
				<option value="c11_save">11</option>
				<option value="c12_save">12</option>
				<option value="c13_save">13</option>
				<option value="c14_save">14</option>
				<option value="c15_save">15</option>
				<option value="c16_save">16</option>
				<option value="c17_save">17</option>
				<option value="c18_save">18</option>
				<option value="c19_save">19</option>
				<option value="c20_save">20</option>
				<option value="c21_save">21</option>
				<option value="c22_save">22</option>
				<option value="c23_save">23</option>
				<option value="c24_save">24</option>
				<option value="c25_save">25</option>
				<option value="c26_save">26</option>
				<option value="c27_save">27</option>
				<option value="c28_save">28</option>
				<option value="c29_save">29</option>
				<option value="c30_save">30</option>
				<option value="c31_save">31</option>
				<option value="c32_save">32</option>
				<option value="c33_save">33</option>
				<option value="c34_save">34</option>
				<option value="c35_save">35</option>
				<option value="c36_save">36</option>
				<option value="c37_save">37</option>
				<option value="c38_save">38</option>
				<option value="c39_save">39</option>
				<option value="c40_save">40</option>
				<option value="c41_save">41</option>
				<option value="c42_save">42</option>
				<option value="c43_save">43</option>
				<option value="c44_save">45</option>
				<option value="c46_save">46</option>
				<option value="c47_save">47</option>
				<option value="c48_save">48</option>
				<option value="c49_save">49</option>
				<option value="c50_save">50</option>
			</select>
			<button class="color save" id="color_save">保存颜色层</button>
			<button id="change_layer" style="margin-left: 100px">隐藏其它图层</button>
		</div>
	</div>
	<!--<div class="color_arrange">
    <button class="color display" id="display_pink">display_pink</button>
    <button class="color save" id="pink_save">save_pink</button>
</div><div class="color_arrange">
    <button class="color display" id="display_brown">display_brown</button>
    <button class="color save" id="brown_save">save_brown</button>
</div><div class="color_arrange">
    <button class="color display" id="display_grey">display_grey</button>
    <button class="color save" id="grey_save">save_grey</button>
</div><div class="color_arrange">
    <button class="color display display" id="display_black">display_black</button>
    <button class="color save" id="black_save">save_black</button>
</div><div class="color_arrange">
    <button class="color display" id="display_gold">display_gold</button>
    <button class="color save" id="gold_save">save_gold</button>
</div><div class="color_arrange">
    <button class="color display" id="display_silver">display_silver</button>
    <button class="color save" id="silver_save">save_silver</button>
</div>-->





	<div class="canvas">
		<canvas class="canvas_layers" id="origin" style="pointer-events:none;position: absolute; z-index: 5000;"></canvas>
		<canvas class="canvas_layers" id="printed" color="rgba(246,62,61,1)" style="position: absolute; z-index: -1;"></canvas>
		<canvas class="canvas_layers" id="written" color="rgba(67,250,85,1)" style="position: absolute; z-index: -2;"></canvas>
		<canvas class="canvas_layers" id="picture" color="rgba(246,247,155,1)" style="position: absolute; z-index: -3;"></canvas>
		<canvas class="canvas_layers" id="labeling" color="rgba(58,212,251,1)" style="position: absolute; z-index: -4;"></canvas>
		<canvas class="canvas_layers" id="c1" color="rgba(254,185,200,1)" style="position: absolute; z-index: -5;"></canvas>
		<canvas class="canvas_layers" id="c2" color="rgba(153,102,51,1)" style="position: absolute; z-index: -6;"></canvas>
		<canvas class="canvas_layers" id="c3" color="rgba(153,153,153,1)" style="position: absolute; z-index: -7;"></canvas>
		<canvas class="canvas_layers" id="c4" color="rgba(20,20,31,1)" style="position: absolute; z-index: -8;"></canvas>
		<canvas class="canvas_layers" id="c5" color="rgba(242,234,56,1)" style="position: absolute; z-index: -9;"></canvas>
		<canvas class="canvas_layers" id="c6" color="rgba(254,185,200,1)" style="position: absolute; z-index: -10;"></canvas>
		<canvas class="canvas_layers" id="c7" color="rgba(153,102,51,1)" style="position: absolute; z-index: -11;"></canvas>
		<canvas class="canvas_layers" id="c8" color="rgba(153,153,153,1)" style="position: absolute; z-index: -12;"></canvas>
		<canvas class="canvas_layers" id="c9" color="rgba(20,20,31,1)" style="position: absolute; z-index: -13;"></canvas>
		<canvas class="canvas_layers" id="c10" color="rgba(242,234,56,1)" style="position: absolute; z-index: -14;"></canvas>
		<canvas class="canvas_layers" id="c11" color="rgba(254,185,200,1)" style="position: absolute; z-index: -15;"></canvas>
		<canvas class="canvas_layers" id="c12" color="rgba(153,102,51,1)" style="position: absolute; z-index: -16;"></canvas>
		<canvas class="canvas_layers" id="c13" color="rgba(153,153,153,1)" style="position: absolute; z-index: -17;"></canvas>
		<canvas class="canvas_layers" id="c14" color="rgba(20,20,31,1)" style="position: absolute; z-index: -18;"></canvas>
		<canvas class="canvas_layers" id="c15" color="rgba(242,234,56,1)" style="position: absolute; z-index: -19;"></canvas>
		<canvas class="canvas_layers" id="c16" color="rgba(254,185,200,1)" style="position: absolute; z-index: -20;"></canvas>
		<canvas class="canvas_layers" id="c17" color="rgba(153,102,51,1)" style="position: absolute; z-index: -21;"></canvas>
		<canvas class="canvas_layers" id="c18" color="rgba(153,153,153,1)" style="position: absolute; z-index: -22;"></canvas>
		<canvas class="canvas_layers" id="c19" color="rgba(20,20,31,1)" style="position: absolute; z-index: -23;"></canvas>
		<canvas class="canvas_layers" id="c20" color="rgba(242,234,56,1)" style="position: absolute; z-index: -24;"></canvas>
		<canvas class="canvas_layers" id="c21" color="rgba(254,185,200,1)" style="position: absolute; z-index: -25;"></canvas>
		<canvas class="canvas_layers" id="c22" color="rgba(153,102,51,1)" style="position: absolute; z-index: -26;"></canvas>
		<canvas class="canvas_layers" id="c23" color="rgba(153,153,153,1)" style="position: absolute; z-index: -27;"></canvas>
		<canvas class="canvas_layers" id="c24" color="rgba(20,20,31,1)" style="position: absolute; z-index: -28;"></canvas>
		<canvas class="canvas_layers" id="c25" color="rgba(242,234,56,1)" style="position: absolute; z-index: -29;"></canvas>
		<canvas class="canvas_layers" id="c26" color="rgba(254,185,200,1)" style="position: absolute; z-index: -30;"></canvas>
		<canvas class="canvas_layers" id="c27" color="rgba(153,102,51,1)" style="position: absolute; z-index: -31;"></canvas>
		<canvas class="canvas_layers" id="c28" color="rgba(153,153,153,1)" style="position: absolute; z-index: -32;"></canvas>
		<canvas class="canvas_layers" id="c29" color="rgba(20,20,31,1)" style="position: absolute; z-index: -33;"></canvas>
		<canvas class="canvas_layers" id="c30" color="rgba(242,234,56,1)" style="position: absolute; z-index: -34;"></canvas>
		<canvas class="canvas_layers" id="c31" color="rgba(254,185,200,1)" style="position: absolute; z-index: -35;"></canvas>
		<canvas class="canvas_layers" id="c32" color="rgba(153,102,51,1)" style="position: absolute; z-index: -36;"></canvas>
		<canvas class="canvas_layers" id="c33" color="rgba(153,153,153,1)" style="position: absolute; z-index: -37;"></canvas>
		<canvas class="canvas_layers" id="c34" color="rgba(20,20,31,1)" style="position: absolute; z-index: -38;"></canvas>
		<canvas class="canvas_layers" id="c35" color="rgba(242,234,56,1)" style="position: absolute; z-index: -39;"></canvas>
		<canvas class="canvas_layers" id="c36" color="rgba(254,185,200,1)" style="position: absolute; z-index: -40;"></canvas>
		<canvas class="canvas_layers" id="c37" color="rgba(153,102,51,1)" style="position: absolute; z-index: -41;"></canvas>
		<canvas class="canvas_layers" id="c38" color="rgba(153,153,153,1)" style="position: absolute; z-index: -42;"></canvas>
		<canvas class="canvas_layers" id="c39" color="rgba(20,20,31,1)" style="position: absolute; z-index: -43;"></canvas>
		<canvas class="canvas_layers" id="c40" color="rgba(242,234,56,1)" style="position: absolute; z-index: -44;"></canvas>
		<canvas class="canvas_layers" id="c41" color="rgba(254,185,200,1)" style="position: absolute; z-index: -45;"></canvas>
		<canvas class="canvas_layers" id="c42" color="rgba(153,102,51,1)" style="position: absolute; z-index: -46;"></canvas>
		<canvas class="canvas_layers" id="c43" color="rgba(153,153,153,1)" style="position: absolute; z-index: -47;"></canvas>
		<canvas class="canvas_layers" id="c44" color="rgba(20,20,31,1)" style="position: absolute; z-index: -48;"></canvas>
		<canvas class="canvas_layers" id="c45" color="rgba(242,234,56,1)" style="position: absolute; z-index: -49;"></canvas>
		<canvas class="canvas_layers" id="c46" color="rgba(254,185,200,1)" style="position: absolute; z-index: -50;"></canvas>
		<canvas class="canvas_layers" id="c47" color="rgba(153,102,51,1)" style="position: absolute; z-index: -51;"></canvas>
		<canvas class="canvas_layers" id="c48" color="rgba(153,153,153,1)" style="position: absolute; z-index: -52;"></canvas>
		<canvas class="canvas_layers" id="c49" color="rgba(20,20,31,1)" style="position: absolute; z-index: -53;"></canvas>
		<canvas class="canvas_layers" id="c50" color="rgba(242,234,56,1)" style="position: absolute; z-index: -54;"></canvas>
		<!--<canvas id="canvas_layers" style="position: absolute;z-index = -1000;"></canvas>-->
		<canvas id="view" style="pointer-events:none;position: absolute; z-index: 5001;"></canvas></div>
</body>
<script src="jquery/jquery-3.3.1.min.js"></script>
<script src="jquery/jcanvas.min.js"></script>
<script src="jquery/jquery.mousewheel.min.js"></script>
<script type="text/javascript">
	//初始化
	//变量申明
	let flag = 0;
	let canvas_view = document.getElementById("view"), ctx_view = canvas_view.getContext('2d');
	let image = new Image();
	let imgData = null, text_content = null, checked = null, note2 = null, count, a = 1;
	//greyArc鼠标跟随
	$(document).on('mousemove', function (e) {
		let r = line_width, x = e.pageX, y = e.pageY;
		let l = $('#origin').offsetLeft, ri = l + $("#origin").offsetWidth, t = $("#origin").offsetTop, b = t + $("#origin").offsetY;
		if (!isErasing) {
			$("#arc").css({
				"position": "absolute",
				"left": e.pageX - line_width / 2,
				"top": e.pageY - line_width / 2,
				"z-index": "10000",
				"width": line_width,
				"height": line_width,
				"border-radius": line_width / 2
			});
		} else {
			$("#arc").css({
				"position": "absolute", "left": e.pageX - erase_r, "top": e.pageY - erase_r, "z-index": "10000",
				"width": erase_r * 2, "height": erase_r * 2, "border-radius": erase_r
			});
		}
	});
	//图像加载
	start(1);
	function start(page) {
		$.get("http://39.106.153.3:2982/api/grading/v1/ocr?amount=all&page=" + page, function (idata) {
			//建立dictionary用于搜索
			let imgData = idata.data;
			let data = [];
			for (let i = 0; i < imgData.length; i++) {
				let splited = imgData[i].split("_");
				data.push(splited);
			}

			function make_dict_tree(list_data) {
				let l_size = list_data[0].length;
				if (l_size == 1) {
					let dd = {}
					for (let i = 0; i < list_data.length; i++) {
						dd[list_data[i][0]] = false;
					}
					return dd;
				} else {
					let dd = {}
					for (let i = 0; i < list_data.length; i++) {
						let l_item = list_data[i]
						let keyy = l_item[0]
						let values = l_item.slice(1, l_item.length)
						if (!(keyy in dd)) {
							dd[keyy] = []
						}
						dd[keyy].push(values)
						// console.log(dd[keyy]);
					}
					for (let key in dd) {
						dd[key] = make_dict_tree(dd[key])
					}
					return dd;
				}
			}

			//填充选项function
			let ddd = make_dict_tree(data);

			function fillOption(key, n) {
				let optnum = 0, strHTMLArray = [], optnam;
				strHTMLArray.push('<option value="please select" style="display: none">' + "请选择" + "</option>>");
				for (let i = 0; i < key.length; i++) {
					optnam = key[i];
					if (n == 3) {
						strHTMLArray.push('<option value="' + optnam + '">' + optnam + '</option>')
					} else {
						strHTMLArray.push('<option value="' + optnum + '">' + optnam + '</option>');
						optnum += 1;
					}
				}
				$("#" + n).html(strHTMLArray.join(''));
			}

			//option change清空界面function
			function clearWindow() {
				image.src = "";
				$("textarea").val("");
				render_canvas();
				render_alphaLayer(0);
			}

			//1号搜索框选项填充
			let text3_ori;
			let keys = Object.keys(ddd), keyss = [], keysss = [];
			fillOption(keys, 1);
			//搜索框内容级连变化
			$("#1").on('change', function () {
				$("#2").empty();
				let option1 = $(this).find('option:selected').val();
				keyss = Object.keys(ddd[keys[option1]]);
				fillOption(keyss, 2);
				$("#3").empty();//清空3级选框
				clearWindow();//清空界面
			});
			$("#2").on('change', function () {
				$("#3").empty();
				let option1 = $("#1").find('option:selected').val();
				let option2 = $(this).find('option:selected').val();
				keysss = Object.keys(ddd[keys[option1]][keyss[option2]]);
				fillOption(keysss, 3);
				clearWindow();//清空界面
				text3_ori = $("#3").find("option:selected").val();//保留3号选框原始选项
			});
			$("#3").on('change', function () {
				let option = $('select').find('option:selected').val();
				let text1 = $("#1").find("option:selected").text();
				let text2 = $("#2").find("option:selected").text();
				let text3 = $("#3").find("option:selected").text();
				if (option !== "please select") {
					let imgsrc = "http://39.106.153.3:2982/gradingdata/solution/" + text1 + "_" + text2 + "_" + text3 + ".png";
					image.src = imgsrc;
					image.onload = function () {
						$.get("http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3, function (data) {
							imgData = data.data;
							text_content = imgData.text_content;
							checked = imgData.checked;
							note2 = imgData.note2;
							//若checked为ture，出现alert，界面不做改变
							if (false) {
								$("#3").val(text3_ori);
								alert("checked\n\n\n" + note2);
								return 0;
							} else {
								text3_ori = text3;
								$("textarea").val("");
								$("#text").val(text_content);
								$("#checked").val(checked);
								$("#note2").val(note2);
								if (imgData.note1 !== "") {
									allDataArray = [];
									reginDic = JSON.parse(imgData.note1);
								} else {
									reginDic = {};
									allDataArray = [];
								}
								for (let i = 0; i < Object.keys(reginDic).length; i++) {
									allDataArray.push(reginDic[i]);
								}
								render_canvas();
								renderLabeling();
								render_alphaLayer(0);
								$.get("http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3 + "/images", function (data) {
									let imagesData = data.data;
									console.log(imagesData)
									//获取oldimage并画在canvas上
									for (let i = 0; i < imagesData.length; i++) {
										let loc = imagesData[i].note1;
										let xval;
										let yval;
										if (loc.length > 0) {
											xval = loc.split('_')[0];
											yval = loc.split('_')[1];
											console.log('not empty');
										} else {
											xval = 0;
											yval = 0;
											console.log('empty');
										}
										let oldImg = new Image();
										oldImg.crossOrigin = "Anonymous";
										oldImg.src = imagesData[i].scan_path;
										let layer_name = imagesData[i].original_filename.split("_")[3].replace(".png", "");
										oldImg.onload = function () {
											$('#' + layer_name).drawImage({
												source: oldImg,
												x: xval,
												y: yval,
												fromCenter: false
											});
											if ($("#" + layer_name).css("z-index") > 0) {
												ctx_view.drawImage(oldImg, xval, yval);
											}
										}
									}
								});
							}
						});
					}
				}
			});
		});
	}

	//重置画布function
	function render_canvas() {
		$('.canvas_layers').clearCanvas();
		let c = $(".canvas_layers");
		for (let i = 0; i < c.length; i++) {
			ctx = c[i].getContext('2d');
			ctx.canvas.width = image.width;
			ctx.canvas.height = image.height;
			//                console.log(image.width,image.height);
		}
		let canvas_view = document.getElementById("view"), ctx_view = canvas_view.getContext('2d');
		ctx_view.canvas.width = image.width;
		ctx_view.canvas.height = image.height;
		$('#origin').drawImage({ source: image, x: 0, y: 0, fromCenter: false });
	}
	//改变alpha
	$("#change_alpha").on('click', function () {
		if ($("#alpha_input").val() >= 0 && $("#alpha_input").val() <= 1) {
			a = $("#alpha_input").val();
			render_alphaLayer(0);
		} else { alert("请输入0到1之间的数字") }
	});
	//checked选择
	$("#true").on('click', function () {
		$("#checked").val("true");
	})
	$("#false").on('click', function () {
		$("#checked").val("false");
	})
	//content分行标记
	$("#text").on('scroll', function (e) {
		count = $(this).scrollTop();
		$("#left").scrollTop(count);
	})
	//提交文本文件
	$("#submit").on('click', function () {
		let option = $('select').find('option:selected').val();
		let text1 = $("#1").find("option:selected").text();
		let text2 = $("#2").find("option:selected").text();
		let text3 = $("#3").find("option:selected").text();
		//获取submit格式
		if (option != "please select") {
			$.get("http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3, function (data) {
				imgData = data.data;
				imgData.note2 = $("#note2").val();
				imgData.text_content = $("#text").val();
				if ($("#checked").val() == "true") { imgData.checked = true };
				if ($("#checked").val() == "false") { imgData.checked = false };
				let textData = JSON.stringify(imgData);
				$.ajax({
					type: "POST",
					url: "http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3,
					data: textData,
					headers: { 'Content-Type': 'application/json' },
					success: success,
					dataType: 'json',
				});
				function success() {
					alert("success");
				};
			});
		}
	});

	//label
	//变量申明display
	let lastX = 0, lastY = 0, x = 0, y = 0, line_width = 20, erase_r = 10, d = 2, h = -55;
	let isDrawing = false, isErasing = false, isIn = false, fullName = new String(), imgName = new String(), islev = false;
	let allDataArray = [], reginDic = {};
	//切换图层
	$(".display").on('change', function () {
		let display_id = $(this).val();
		//console.log($(this).val());
		let number_text = display_id.split("_")[0];
		let layer_color = $("#" + number_text).attr("color");

		$("#" + number_text).css('z-index', d);
		d += 1;
		$(this).css("background-color", layer_color);

		render_alphaLayer(0);
	});
	$(".display").not('#select').on('click', function () {
		let display_id = $(this).attr("id");
		let layer_color = $("#" + display_id.split("_")[1]).attr("color");
		render_alphaLayer(0);
	});

	$('#select').on('click', function () {
		let display_id = $(this).attr("id");
		let layer_color = $("#" + display_id.split("_")[1]).attr("color");
		render_alphaLayer(1);
	});

	$('#select').val('c1_save').change();
	//保存图层
	$(".save").on('click', function () {
		let text1 = $("#1").find("option:selected").text();
		let text2 = $("#2").find("option:selected").text();
		let text3 = $("#3").find("option:selected").text();
		let save_id;
		if ($(this).attr("id") !== "color_save") {
			save_id = $(this).attr("id");
		} else {
			save_id = $("#select").val();
		}
		if (save_id !== "labeling_save") {
			let save_color = save_id.split("_")[0];
			let save_cvs = document.getElementById(save_color);
			let color = save_cvs.getAttribute('color');
			color = color.slice(5, -1);
			let color_lst = color.split(",");
			let r = color_lst[0];
			let g = color_lst[1];
			let b = color_lst[2];
			let ctx = save_cvs.getContext("2d");
			let original_width = save_cvs.width;
			let original_height = save_cvs.height;
			let x_left = 10000;
			let x_right = 0;
			let y_top = 10000;
			let y_bottom = 0;
			let img = ctx.getImageData(0, 0, original_width, original_height);
			let imgData = img.data;
			for (let i = 0; i < imgData.length; i += 4) {
				if (imgData[i] == r && imgData[i + 1] == g && imgData[i + 2] == b) {
					let y_cor = (i / 4) / original_width;
					let x_cor = (i / 4) % original_width;
					if (x_cor < x_left) {
						x_left = x_cor;
					}
					if (x_cor > x_right) {
						x_right = x_cor;
					}
					if (y_cor < y_top) {
						y_top = y_cor;
					}
					if (y_cor > y_bottom) {
						y_bottom = y_cor;
					}
				}
			}
			//console.log(r);
			//console.log(g);
			//console.log(b);
			console.log(x_left);
			console.log(x_right);
			console.log(y_top);
			console.log(y_bottom);
			render_alphaLayer(0);
			let width = x_right - x_left;
			let height = y_bottom - y_top;
			console.log(width);
			console.log(height);
			let canvas = document.createElement('canvas');
			canvas.setAttribute("id", "canvas");
			canvas.setAttribute("style", "position: absolute;z-index = -1000;");
			let ctx1 = canvas.getContext("2d");
			ctx1.canvas.width = width;
			ctx1.canvas.height = height;
			let val1 = canvas.toDataURL();
			img = ctx.getImageData(x_left, y_top, width, height);
			ctx1.putImageData(img, 0, 0);
			let val2 = canvas.toDataURL();
			console.log(val1.split(',')[1] == val2.split(',')[1]);
			ctx1.canvas.width = original_width;
			ctx1.canvas.height = original_height;
			ctx1.clearRect(0, 0, canvas.width, canvas.height);

			let blobBin = atob(val2.split(',')[1]);
			let array = [];
			for (let i = 0; i < blobBin.length; i++) {
				array.push(blobBin.charCodeAt(i));
			}
			let file = new File([new Uint8Array(array)], text1 + "_" + text2 + "_" + text3 + "_" + save_color + '.png', { type: 'image/png', lastModified: Date.now() });
			let formdata = new FormData();
			formdata.append("images", file);
			let position = x_left + '_' + y_top;
			let pos_obj = {
				note1: position
			};
			formdata.append("data", JSON.stringify(pos_obj));
			//检查是否存在image，若有，删除
			$.get("http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3 + "/images", function (data) {
				let imagesData = data.data;
				for (let i = 0; i < imagesData.length; i++) {
					if (imagesData[i].original_filename == text1 + "_" + text2 + "_" + text3 + "_" + save_color + ".png") {
						$.ajax({
							type: "DELETE",
							url: "http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3 + "/images/" +
								imagesData[i].image_id,
							headers: { 'Content-Type': 'application/json' },
							success: delete_success,
						});
						function delete_success() {
							console.log('Deleted');
						}
					}
				}
			});
			//post最新image
			$.ajax({
				url: "http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3 + "/images",
				type: "POST",
				data: formdata,
				processData: false,
				contentType: false,
				mimeType: "image/png"
			}).done(function (respond) {
				//					  Access-Control-Allow-Origin: *;
				alert("done");
			}).fail(function (res) { alert("fail") });
		}
		else {
			$.get("http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3, function (data) {
				imgData = data.data;
				imgData.note1 = JSON.stringify(reginDic);
				let textData = JSON.stringify(imgData);
				$.ajax({
					type: "POST",
					url: "http://39.106.153.3:2982/api/grading/v1/ocr/" + text1 + "_" + text2 + "_" + text3,
					data: textData,
					headers: { 'Content-Type': 'application/json' },
					success: success,
				});
				function success() {
					alert("success");
				};
			});
		}
	});
	//alpha_function
	function render_alphaLayer(flag) {

		let c = $(".canvas_layers");
		ctx_view.clearRect(0, 0, canvas_view.width, canvas_view.height);
		// ctx_view.globalAlpha = a;
		for (let i = 1; i < c.length; i++) {
			if (c[i].style.zIndex > 0) {
				if (flag !== 1) {
					ctx_view.drawImage(c[i], 0, 0);
				}
			}
		}
	}
	//圆形笔擦function
	function clearArcFun(x, y, r, ctx) {
		let stepClear = 1;
		clearArc(x, y, r);
		function clearArc(x, y, radius) {
			let calcWidth = radius - stepClear;
			let calcHeight = Math.sqrt(radius * radius - calcWidth * calcWidth);

			let posX = x - calcWidth;
			let posY = y - calcHeight;

			let widthX = 2 * calcWidth;
			let heightY = 2 * calcHeight;

			if (stepClear <= radius) {
				ctx.clearRect(posX, posY, widthX, heightY);
				stepClear += 1;
				clearArc(x, y, radius);
			}
		}
	}
	//遍历及填充特定颜色部分function(skip over some pixels, make things faster but can be incorrect)
	let SKIP = 2, to_color = [];
	function floodFill(x, y, check_layer) {
		// get the red canvas for now . . .
		let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
		// the list of stuff to be filled
		to_color = [];
		// the string hash of visited
		let visited = new Set([]);

		let frontier = [[x, y]];
		function close_to_red(a_color) {
			return Math.abs(a_color[3] - 255) < 10;
		}
		while (frontier.length > 0) {
			let cur_node = frontier.pop();
			// if the current node is not already in the set
			if (visited.has(String(cur_node)) == false) {
				visited.add(String(cur_node));
				let cur_x = cur_node[0];
				let cur_y = cur_node[1];

				let node_color = ctx.getImageData(cur_x, cur_y, 1, 1).data;
				//if ((node_color[0] == 255) && node_color[1] == 62) {
				if (close_to_red(node_color)) {
					to_color.push([cur_x, cur_y]);
					for (let i = -1; i < 2; i++) {
						for (let j = -1; j < 2; j++) {
							let new_x = cur_x + i * SKIP;
							let new_y = cur_y + j * SKIP;
							frontier.push([new_x, new_y]);
						}
					}
				}
			}
		}

		// actually fill the stuff in the list
		if (to_color.length > 10) {
			for (let i = 0; i < to_color.length; i++) {
				let color_rgba = ctx.getImageData(to_color[i][0], to_color[i][1], 1, 1).data;
				//                console.log(color_rgba);
				if (color_rgba[0] == 255 || (color_rgba[1] < 256 && color_rgba[1] > 250)) {
					fillColor(to_color[i][0], to_color[i][1], check_layer);
				}
				else {
					fillWhite(to_color[i][0], to_color[i][1], check_layer);
				}
			}
		}
	}
	function fillWhite(x, y, check_layer) {
		// this function will actually change the color of our box
		let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
		ctx.fillStyle = "white";
		ctx.fillRect(x - SKIP / 2 + 1, y - SKIP / 2 + 1, SKIP, SKIP);
	}
	function fillColor(x, y, check_layer) {
		let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
		let fillcolor = $("#" + check_layer).attr("color");
		console.log(fillcolor);
		ctx.fillStyle = fillcolor;
		ctx.fillRect(x - SKIP / 2 + 1, y - SKIP / 2 + 1, SKIP, SKIP);
	}
	//取消鼠标右键默认事件防止干扰检验操作
	document.oncontextmenu = function (event) {
		event.preventDefault();
	};
	// 检验&画笔状态判断
	$("canvas").on('mousedown ', function (e) {
		if (e.which == 3) {
			e.preventDefault();
			let check_layer = $(this).attr("id");
			let xi = e.offsetX, yi = e.offsetY;
			floodFill(xi, yi, check_layer);
			render_alphaLayer(0);
		}
		else {
			isDrawing = true;
			[lastX, lastY] = [e.offsetX, e.offsetY];
		}
	});
	$("canvas").on('mouseup', function () {
		isDrawing = false;
	});
	$("canvas").on('mouseout', function () {
		isDrawing = false;
		isIn = false;
	});
	$("canvas").on('mouseenter', function () {
		isIn = true;
	})
	//水平画线判断
	$(document).keydown(function (e) {
		if (e.keyCode == 32) {
			if (isIn) {
				e.preventDefault();
				islev = true;
			}
		}
	});
	$(document).keyup(function (e) {
		if (e.keyCode == 32) {
			e.preventDefault();
			islev = false;
		}
	})
	//画笔&擦除&Arc尺寸
	$(document).mousewheel(function (e, delta) {
		if (!isErasing) {
			if (isDrawing) {
				e.preventDefault();
				let dir = delta > 0 ? 'Up' : 'Down';
				if (dir == 'Up') {
					line_width += 3;
				} else {
					line_width -= 3;
				}
			}
			$("#arc").css({
				"position": "absolute", "left": e.pageX - line_width / 2, "top": e.pageY - line_width / 2, "z-index": "10000",
				"width": line_width, "height": line_width, "border-radius": line_width / 2
			});
		}
		else {
			if (isDrawing) {
				e.preventDefault();
				let dir = delta > 0 ? 'Up' : 'Down';
				if (dir == 'Down' && erase_r > 6) {
					erase_r -= 3;
				} else {
					erase_r += 3;
				}
			}
			$("#arc").css({
				"position": "absolute", "left": e.pageX - erase_r, "top": e.pageY - erase_r, "z-index": "10000",
				"width": erase_r * 2, "height": erase_r * 2, "border-radius": erase_r
			});
		}
	});
	//擦除状态选择
	$("#Erase").on('click', function () {
		if (isErasing) {
			$(this).css("background-color", "white");
			isErasing = false;
		}
		else {
			$(this).css("background-color", "red")
			isErasing = true;
		}
	})
	//实时画图
	$("canvas").on('mousemove', function (e) {
		if (!$(this).is("#labeling")) {
			let canvas = $(this).get(0), ctx = canvas.getContext('2d');
			if (isDrawing && !$(this).is('#origin')) {
				x = e.offsetX;
				y = e.offsetY;
				if (!isErasing) {
					//原图
					ctx.lineWidth = line_width;
					ctx.lineCap = "round";
					ctx.lineJoin = "round";
					ctx.strokeStyle = $(this).attr("color");
					ctx.beginPath();
					ctx.moveTo(lastX, lastY);
					if (islev == true) {
						ctx.lineTo(x, lastY);
						ctx.stroke();
						[lastX, lastY] = [x, lastY];
					}
					else if (islev == false) {
						ctx.lineTo(x, y);
						ctx.stroke();
						[lastX, lastY] = [x, y];
					}
				}
				else {
					clearArcFun(x, y, erase_r, ctx);
					// ctx_prev.clearRect(x,y,100,100);
				}
				render_alphaLayer(0);
			}
		}
	});

	//线框编辑
	//线框位置信息记录
	let curRectArray = [], curPoint = [];
	function CopyCurPoint(a) {
		return [a[0], a[1]];
	}
	function CopyCurRect(b) {
		return [b[0], b[1], b[2], b[3]];
	}
	//逆时针计算
	function reArrange(l1, l2, l3, l4) {
		let en = [];
		let pn = [[l1, 0], [l2, 1], [l3, 2], [l4, 3]]
		let pnb = pn.slice(0);
		pn.sort((a, b) => { return a[0][0] - b[0][0]; });
		if (pnb[pn[0][1]][0][1] < pnb[pn[1][1]][0][1]) {
			en[0] = pnb[pn[0][1]][0]
			en[1] = pnb[pn[1][1]][0]
		} else {
			en[0] = pnb[pn[1][1]][0]
			en[1] = pnb[pn[0][1]][0]
		}

		if (pnb[pn[2][1]][0][1] > pnb[pn[3][1]][0][1]) {
			en[2] = pnb[pn[2][1]][0]
			en[3] = pnb[pn[3][1]][0]
		} else {
			en[2] = pnb[pn[3][1]][0]
			en[3] = pnb[pn[2][1]][0]
		}
		return [en[0], en[1], en[2], en[3]]
	}
	//勾线function
	function renderLabeling() {
		let canvas_labeling = document.getElementById('labeling');
		let ctx = canvas_labeling.getContext('2d');
		ctx.clearRect(0, 0, 1000, 2000);
		//		console.log(allDataArray);
		for (let i = 0; i < allDataArray.length; i++) {
			ctx.beginPath();
			ctx.moveTo(allDataArray[i][0][0], allDataArray[i][0][1]);
			ctx.lineTo(allDataArray[i][1][0], allDataArray[i][1][1]);
			ctx.lineTo(allDataArray[i][2][0], allDataArray[i][2][1]);
			ctx.lineTo(allDataArray[i][3][0], allDataArray[i][3][1]);
			ctx.closePath();
			ctx.stroke();
			ctx.font = "12px '微软雅黑'";
			ctx.fillText(i + 1, allDataArray[i][3][0], allDataArray[i][3][1]);
		}
	}
	//创建dictionary
	function CreatUpLoadArray() {
		reginDic = {};
		for (let i = 0; i < allDataArray.length; i++) {
			reginDic[i] = allDataArray[i];
		}
		//		console.log(reginDic);
	}
	//勾线
	$("#labeling").on('click', function (e) {
		curPoint[0] = e.offsetX;
		curPoint[1] = e.offsetY;
		if (curRectArray.length < 3) {
			let rectPoint = CopyCurPoint(curPoint);
			curRectArray.push(rectPoint);
		} else {
			let rectPoint = CopyCurPoint(curPoint);
			curRectArray.push(rectPoint);
			let rectArray = CopyCurRect(curRectArray);
			rectArray = reArrange(rectArray[0], rectArray[1], rectArray[2], rectArray[3]);
			allDataArray.push(rectArray);
			//			console.log(allDataArray);
			renderLabeling();
			curRectArray = [];
			CreatUpLoadArray();
			render_alphaLayer(0);
		}
	});
	//撤回勾线
	$("#rollback").on('click', function () {
		allDataArray.pop();
		//		console.log(allDataArray);
		renderLabeling();
		CreatUpLoadArray();
		render_alphaLayer(0);
	});


	$("#change_layer").on('click', function () {
		let layer_value = $('#select').val();
		let layer_id = layer_value.split("_")[0];
		for (let i = 1; i < 51; i++) {
			if ("c" + i.toString() !== layer_id) {
				if (flag % 2 == 0) {
					$("#c" + i.toString()).css('z-index', -1000);
					//h-=1;
				} else {
					$("#c" + i.toString()).css('z-index', 1);
					//d+=1;
				}
			}
		}
		flag += 1;
		render_alphaLayer(0);
	});

	$("#selectpage").on('click', function () {
		let page_number = $("#inputpage").val();
		start(page_number);
	});

</script>

</html>