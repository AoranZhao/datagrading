<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>edit text_content</title>
</head>
<style>
    html body div {
        margin: 0;
        padding: 0;
    }
    #latexdiv{
		margin: 0;
		padding: 0;
        top: 370px;
        position: absolute;
        float: left;
        height:467px;
        overflow: scroll;
        overflow-x:hidden;
        border:2px #000000 solid;
    }
    .btns{
        position: absolute;
        top:15px;
        width: 80px;
        background-color: white;
        border-radius: 2px;
    }
    textarea{
        background-color: aquamarine;
        font-size: 18px;
        resize: none;
		position: absolute;
		width: 263px;
    }
	#text{
		width: 1106px;
		height: 235px;
		left: 280px;
		top:600px;
	}
	#checked{
		top:320px;
		height: 21px;
	}
	#note2{
        top:80px;
        height: 200px;
	}

	.layer_btn{
            position: absolute;
            width: 100px;
            height: 100px;
            top: 60px;
		 	left: 1200px;
        }
        .color{
            width:90px;
            margin-left: 2px;
        }

        .color_arrange{
            width: 190px;
            margin-bottom: 25px;

        }
        .canvas{
            position : absolute;
            left: 280px;
            top: 60px;
			height:500px;
			width:917px;
			overflow-y: scroll;
        }
        #arc{
            position: absolute;
            left:10000px;
            top:10000px;
            width:50px;
            height:50px;
            border-radius: 25px;
            border-width: 1px;
            background-color: rgba(0,0,0,0.4);
        }
	.layTex{
		    border-bottom:1px solid black;
		    margin: 0;padding: 0;
			width:64px;
			height: 16px;
			font-size: 12px;
			background-color: white;
		    text-align:center;
	}

</style>

<body>

<div >
    <select class="btns" id="1" style="left:10px"></select>
    <select class="btns" id="2" style="left:90px"></select>
    <select class="btns" id="3" style="left:170px"></select>
	<button class="btns" id="Erase" style="left: 400px; background-color: white">擦除</button>
    <button class= "btns" id="submit" style="left: 300px">提交文字</button></div>
	<button class="btns" id="rollback" style="left:500px ">撤销</button>
</br>
<span style="position: absolute;top: 570px; left:280px;font-size: 18px;">text_content:</span>
<textarea id="text" ></textarea>
<span style="position: absolute;top: 290px; font-size: 18px;">checked:</span>
<div id="checked_btn">
	<button class="btns" id="true" style="position: absolute;top: 293px; left:100px; font-size: 14px;">true</button>
	<button class="btns" id="false" style="position: absolute;top: 293px; left:183px; font-size: 14px;">false</button>
</div>
<textarea id="checked"></textarea>
<span style="position: absolute;top: 50px;font-size: 18px;">note2:</span>
<textarea id="note2"></textarea>
<div class = "imgArea" id="latexdiv">
	<ul class="layText" style=" margin: 0; padding: 0;position:absolute; left:-10px; top: -84.7px;transform: scale(0.67);">
		<li class="layTex">\cdot</li>
		<li class="layTex">\cot</li>
		<li class="layTex">\cos</li>
		<li class="layTex">\tan</li>
		<li class="layTex">\sin</li>
		<li class="layTex">\geq</li>
		<li class="layTex">\leq</li>
		<li class="layTex">\sim</li>
		<li class="layTex">\beta</li>
		<li class="layTex">\alpha</li>
		<li class="layTex">\theta</li>
		<li class="layTex">\%</li>
		<li class="layTex">\pi</li>
		<li class="layTex">\prime</li>
		<li class="layTex">\cong</li>
		<li class="layTex" style="height: 25px">\pm</li>
		<li class="layTex">\neq</li>
		<li class="layTex">\div</li>
		<li class="layTex">\times</li>
		<li class="layTex">\because</li>
		<li class="layTex">\therefore</li>
		<li class="layTex">\Delta</li>
		<li class="layTex">\angle</li>
		<li class="layTex">\sqrt</li>
		<li class="layTex">\vec</li>
		<li class="layTex">\perp</li>
		<li class="layTex">\circ</li>
		<li class="layTex">_</li>
		<li class="layTex">^</li>
		<li class="layTex">\hat</li>
		<li class="layTex">\arc</li>
		<li class="layTex">\frac</li>
		<li class="layTex">\cdots</li>
		<li class="layTex">\odot</li>
		<li class="layTex">\parallel</li>
		<li class="layTex">\approx</li>
		<li class="layTex">\bar</li>
		<li class="layTex">\gamma</li>
	</ul>
    <img src="image/LaTeX说明1.png" style="width: 250px"/>
   </div>
	<div id="arc" style="pointer-events:none"></div>
<div class="layer_btn">
    <div class="color_arrange">
    <button class="color hide" id="hide_printed">隐藏打印层</button>
    <button class="color display" id="display_printed">显示打印层</button>
    <button class="color save" id="printed_save">保存打印层</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_written">隐藏手写层</button>
    <button class="color display" id="display_written">显示手写层</button>
    <button class="color save" id="written_save">保存手写层</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_picture">隐藏图片层</button>
    <button class="color display" id="display_picture">显示图片层</button>
    <button class="color save" id="picture_save">保存图片层</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_labeling">隐藏标记层</button>
    <button class="color display" id="display_labeling">显示标记层</button>
    <button class="color save" id="labeling_save">保存标记层</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_pink">hide_pink</button>
    <button class="color display" id="display_pink">display_pink</button>
    <button class="color save" id="pink_save">save_pink</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_brown">hide_brown</button>
    <button class="color display" id="display_brown">display_brown</button>
    <button class="color save" id="brown_save">save_brown</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_grey">hide_grey</button>
    <button class="color display" id="display_grey">display_grey</button>
    <button class="color save" id="grey_save">save_grey</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_black">hide_black</button>
    <button class="color display display" id="display_black">display_black</button>
    <button class="color save" id="black_save">save_black</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_gold">hide_gold</button>
    <button class="color display" id="display_gold">display_gold</button>
    <button class="color save" id="gold_save">save_gold</button>
</div><div class="color_arrange">
    <button class="color hide" id="hide_silver">hide_silver</button>
    <button class="color display" id="display_silver">display_silver</button>
    <button class="color save" id="silver_save">save_silver</button>
</div>
</div>
<div class="canvas">
    <canvas  class="canvas_layers" id="origin"  style="position: absolute; z-index: 0;"></canvas>
    <canvas class="canvas_layers" id="printed"    color="rgba(246,62,61,1)"   style="position: absolute; z-index: -1;"></canvas>
    <canvas class="canvas_layers" id="written"  color="rgba(67,250,85,1)"   style="position: absolute; z-index: -2;"></canvas>
    <canvas class="canvas_layers" id="picture" color="rgba(246,247,155,1)" style="position: absolute; z-index: -3;"></canvas>
    <canvas class="canvas_layers" id="labeling"   color="rgba(58,212,251,1)"  style="position: absolute; z-index: -4;"></canvas>
    <canvas class="canvas_layers" id="pink"   color="rgba(254,185,200,1)" style="position: absolute; z-index: -5;"></canvas>
    <canvas class="canvas_layers" id="brown"  color="rgba(153,102,51,1)"  style="position: absolute; z-index: -6;"></canvas>
    <canvas class="canvas_layers" id="grey"   color="rgba(153,153,153,1)" style="position: absolute; z-index: -7;"></canvas>
    <canvas class="canvas_layers" id="black"  color="rgba(20,20,31,1)"    style="position: absolute; z-index: -8;"></canvas>
    <canvas class="canvas_layers" id="gold"   color="rgba(242,234,56,1)"  style="position: absolute; z-index: -9;"></canvas>
    <canvas class="canvas_layers" id="silver" color="rgba(192,192,192,1)"  style="position: absolute; z-index: -10;"></canvas>
    <!--<canvas class="canvas_layers" id="preview"  style="position: absolute; z-index: 0;"></canvas>-->
</div>
</body>

<script src="jquery/jquery-3.3.1.min.js"></script>
<script src="jquery/jcanvas.min.js"></script>
<script src="jquery/jquery.mousewheel.min.js"></script>
<script type="text/javascript">
    //变量申明
    let fr = new FileReader(), image= new Image();
    let imgData = null, text_content = null, checked=null, note2=null;
	let allDataArray = [], reginDic = {};
    //图像加载
    // $.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/", function( data ) {
    //     let imgData = data.data;
    //     let strHTMLArray = [] ;
    //     strHTMLArray.push('<option value=0>'+"SELECT PIXTURE"+"</option>");
    //     for (let i = 0; i<imgData.length; i++ ){
    //         let imgName = imgData[i];
    //         strHTMLArray.push('<option value="'+imgName+'">'+imgName+'</option>');
    //     }
    //     $("#imgList").html(strHTMLArray.join(''));
    // });

    $.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/", function(idata ) {
        let imgData = idata.data;
        let data = [];
        for (let i=0; i<imgData.length; i++){
            let splited = imgData[i].split("_");
            data.push(splited);
        }

        function make_dict_tree(list_data) {
            let l_size = list_data[0].length;
            // [ [1], [2], [1], [3] ]
            if (l_size == 1){
                let dd = {}
                for (let i = 0; i < list_data.length; i++){
                    dd[list_data[i][0]] = false;
                }
                return dd;
            }
            else {
                let dd = {}
                for (let i = 0; i < list_data.length; i++) {
                    let l_item = list_data[i]
                    let keyy = l_item[0]
                    let values = l_item.slice(1, l_item.length)
                    if (!(keyy in dd)) {
                        dd[keyy] = []
                    }
                    dd[keyy].push(values)
                    // console.log(dd[keyy]);
                }
                for (let key in dd) {
                    dd[key] = make_dict_tree(dd[key])
                }
                return dd;
            }
        }

        let ddd = make_dict_tree(data);
        let optnam1, optnam2, optnam3,optnum1 = 0, optnum2 = 0, optnum3 =0, keys =[], keyss = [], keysss=[];
        let strHTMLArray1 = [], strHTMLArray2 = [],strHTMLArray3 = [], liHTMLArray1 = [], liHTMLArray2 = [], liHTMLArray3 = [];
        strHTMLArray1.push('<option value="please select" style="display: none">' + "请选择" + "</option>>");
        keys = Object.keys(ddd);
        for (let i=0 ; i <keys.length; i++){
            optnam1 = keys[i];
            strHTMLArray1.push('<option value="'+optnum1+'">'+optnam1+'</option>');
            optnum1 += 1;
        }
        $("#1").html(strHTMLArray1.join(''));
        $("#1").on('change', function () {
            $("#2").empty();
            strHTMLArray2 = [];
            strHTMLArray2.push('<option value="please select" style="display: none">' + "请选择" + "</option>");
            let option1 = $(this).find('option:selected').val();
            keyss = Object.keys(ddd[keys[option1]]);
            optnum2 = 0;
            for (let i=0; i<keyss.length; i++) {
                optnam2 = keyss[i];
                strHTMLArray2.push('<option value="' + optnum2 + '">' + optnam2 + '</option>');
                optnum2 +=1;
            }
            $("#2").html(strHTMLArray2.join(''));

            $("#3").empty();
            strHTMLArray3 = [];
            liHTMLArray3 = [];

            image.src = "";
            $("textarea").val("");
            render_canvas();

        });
        $("#2").on('change',function(){
            $("#3").empty();
            strHTMLArray3 = [];
            liHTMLArray3 = [];
            let option1 = $("#1").find('option:selected').val();
            let option2 = $(this).find('option:selected').val();
            keysss = Object.keys(ddd[keys[option1]][keyss[option2]]);
            strHTMLArray3.push('<option value="please select" style="display: none">' + "请选择" + "</option>>");
            optnum3 = 0;
            for(let i=0; i<keysss.length; i++){
                optnam3  = keysss[i];
                strHTMLArray3.push('<option value="' + optnum3 + '">' + optnam3 + '</option>');
                optnum3+=1;
            }
            optnum3 = 0;
            for (let i=0; i<keysss.length; i++){
                optnam3  = keysss[i];
                liHTMLArray3.push('<li value="' + optnum3 + '">' + optnam3 + '</li>');
                optnum3+=1;
            }
            $("#3").html(strHTMLArray3.join(''));
            $("#options").html(liHTMLArray3.join(''));
            image.src = "";
            $("textarea").val("");
            render_canvas();
        });

    });
    $("#3").on('change',function(){
        let option = $('select').find('option:selected').val();
        let text1=$("#1").find("option:selected").text();
        let text2=$("#2").find("option:selected").text();
        let text3=$("#3").find("option:selected").text();
        if(option!=="please select"){
            let imgsrc = "http://datagrading.learnable.ai/gradingdata/solution/"+text1+"_"+text2+"_"+text3+".png";
            image.src = imgsrc;
            image.onload = function () {
                $.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3, function( data ) {
                    imgData = data.data;
                    text_content = imgData.text_content;
					checked = imgData.checked;
					note2=imgData.note2;
                    // console.log(text_content);
                    $("textarea").val("");
                    $("#text").val(text_content);
					$("#checked").val(checked);
					$("#note2").val(note2);
					if( imgData.note1 !== ""){
						allDataArray = [];
						reginDic = JSON.parse(imgData.note1);
					}
					else{
						reginDic = {};
						allDataArray=[];
					}
					for(let i=0; i<Object.keys(reginDic).length;i++){
						allDataArray.push(reginDic[i]);
					}
                    render_canvas();
					renderLabeling();
					let printedImg = new Image(), writtenImg = new Image(), pictureImg = new Image();
					$.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3+"/images", function( data ) {
							let imagesData = data.data ;
							for(let i = 0;i<imagesData.length;i++){
								if(imagesData[i].original_filename==text1+"_"+text2+"_"+text3+"_printed.png"){
								   printedImg.crossOrigin = "Anonymous";
									printedImg.src ="http://"+imagesData[i].scan_path;
									$('#printed').drawImage({source:printedImg,x:0,y:0,fromCenter:false});
									}
								else if(imagesData[i].original_filename==text1+"_"+text2+"_"+text3+"_written.png"){
									writtenImg.crossOrigin = "Anonymous";
									writtenImg.src ="http://"+imagesData[i].scan_path;
									$('#written').drawImage({source:writtenImg,x:0,y:0,fromCenter:false});
									}
								else if(imagesData[i].original_filename==text1+"_"+text2+"_"+text3+"_picture.png"){
								    pictureImg.crossOrigin = "Anonymous";
									pictureImg.src ="http://"+imagesData[i].scan_path;
									$('#picture').drawImage({source:pictureImg,x:0,y:0,fromCenter:false});
									}
								else{
									console.log("This id has no image");
								}
							}
						});
                });
            }
        }
    });
    $("#submit").on('click', function () {
        let option = $('select').find('option:selected').val();
        let text1=$("#1").find("option:selected").text();
        let text2=$("#2").find("option:selected").text();
        let text3=$("#3").find("option:selected").text();
        //获取submit格式
        if(option!="please select"){
            $.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3, function( data ) {
                imgData = data.data;
				imgData.note2 = $("#note2").val();
                imgData.text_content = $("#text").val();
				if($("#checked").val()=="true"){imgData.checked = true};
				if($("#checked").val()=="false"){imgData.checked = false};
                let textData = JSON.stringify(imgData);
                $.ajax({
                    type: "POST",
                    url:  "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3,
                    data:textData,
                    headers: { 'Content-Type': 'application/json' },
                    success: success,
                    dataType:'json',
                });
                function success() {
                    alert("success");
                };
            });
        }
    });
//checked选择
	$("#true").on('click',function(){
		$("#checked").val("true");
	})
	$("#false").on('click',function(){
		$("#checked").val("false");
	})
	
	
	
//重置画布
    function render_canvas() {
		$('.canvas_layers').clearCanvas();
            let c = $(".canvas_layers");
            for(let i = 0; i<c.length; i++){
                ctx = c[i].getContext('2d');
                ctx.canvas.width=image.width;
                ctx.canvas.height=image.height;
                console.log(image.width,image.height);
            }
//			let image2 = new Image();
//			image2.src="image/_printed.png"
//			$("#printed").drawImage({source:image2,x:0,y:0,fromCenter:false});
            $('#origin').drawImage({source:image,x:0,y:0,fromCenter:false});
    }
	
	//label
	$(".hide").css({"display":"none","background-color":"grey","height":"20px", "position":"absolute","top":"24px","border-radius":"5px"}).text("hide暂不可用");
    let lastX=0, lastY=0,x=0,y=0, line_width=20, erase_r=10, d = 1 , h = -11;
    let isDrawing = false, isErasing = false, isIn=false,fullName= new String(), imgName = new String(), islev = false;
	
    //切换图层
    $(".display").on('click', function(){
        let display_id = $(this).attr("id");
        let layer_color = $("#"+display_id.split("_")[1]).attr("color");
        let layer_state = $("#"+display_id.split("_")[1]).css('z-index');
        // console.log(layer_state,layer_state>0);
        if(layer_state<0) {
            $("#" + display_id.split("_")[1]).css('z-index', d);
            d += 1;
            $(this).css("background-color",layer_color);
            // console.log(display_id.split("_")[1],$("#"+display_id.split("_")[1]).css('z-index'));
        }
        else{
            $("#"+display_id.split("_")[1]).css('z-index',h);
            h -= 1;
            $(this).css("background-color","white");
        }

    });


    //保存图片
//    function download(type,imgdata,imgcolor) {
//        //设置保存图片的类型
//
//        //将mime-type改为image/octet-stream,强制让浏览器下载
//        let fixtype = function (type) {
//            // type = type.toLocaleLowerCase().replace(/jpg/i, 'jpeg');
//            let r = type.match(/png|jpeg|bmp|gif/)[0];
//            return 'image/' + r;
//        }
//        imgdata = imgdata.replace(fixtype(type), 'image/octet-stream')
//        //将图片保存到本地
//        let saveFile = function (data, filename) {
//            let link = document.createElement('a');
//            link.href = data;
//            link.download = filename;
//            let event = document.createEvent('MouseEvents');
//            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
//            link.dispatchEvent(event);
//        }
//        let filename = imgName + "_" +imgcolor + '.' + type;
//        saveFile(imgdata, filename);
//    }

    $(".save").on('click', function () {
		let text1=$("#1").find("option:selected").text();
        let text2=$("#2").find("option:selected").text();
        let text3=$("#3").find("option:selected").text();
        let save_id = $(this).attr("id");
		if(save_id!=="labeling_save"){
					let save_color = save_id.split("_")[0];
					let save_cvs = document.getElementById(save_color);
//				img.setAttribute('crossorigin', 'anonymous');
					let dataURL = save_cvs.toDataURL();
					let blobBin = atob(dataURL.split(',')[1]);
					let array = [];
					for(let i = 0; i < blobBin.length; i++) {
						array.push(blobBin.charCodeAt(i));
					}
					let file=new File([new Uint8Array(array)], text1+"_"+text2+"_"+text3+"_"+save_color+'.png', {type: 'image/png', lastModified: Date.now()});
					let formdata = new FormData();
					formdata.append("images", file);
					//检查是否存在image，若有，删除
					$.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3+"/images", function( data ) {
							let imagesData = data.data ;
							for(let i = 0;i<imagesData.length;i++){
									if(imagesData[i].original_filename==text1+"_"+text2+"_"+text3+"_"+save_color+".png"){
									   $.ajax({
											type: "DELETE",
											url:  "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3+"/images/"+
													imagesData[i].image_id,
											headers: { 'Content-Type': 'application/json' },
											success : delete_success,
										});
										function delete_success() {
											console.log('Deleted');
										}
								}
						  }
					});
					//post最新image
					$.ajax({
					   url: "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3+"/images",
					   type: "POST",
					   data: formdata,
					   processData: false,
					   contentType: false,
						mimeType: "image/png"
					}).done(function(respond){
//					  Access-Control-Allow-Origin: *;
					  alert("done");
					}).fail(function(res) {alert("fail")});
		    }
		else{
			    $.get( "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3, function( data ) {
                imgData = data.data;
                imgData.note1 =JSON.stringify(reginDic);
                let textData = JSON.stringify(imgData);
                $.ajax({
                    type: "POST",
                    url:  "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3,
                    data:textData,
                    headers: { 'Content-Type': 'application/json' },
                    success: success,
                    dataType:'json',
                });
                function success() {
                    alert("success");
                };
            });
		}
	});
//	$(".delete").on('click', function () {
//		let text1=$("#1").find("option:selected").text();
//        let text2=$("#2").find("option:selected").text();
//        let text3=$("#3").find("option:selected").text();
//
//        $.ajax({
//            type: "DELETE",
//            url:  "http://datagrading.learnable.ai/api/grading/v1/ocr/"+text1+"_"+text2+"_"+text3+"/images/"+"5c68d73459fe0abea5c40a7a21ce3a19",
//            headers: { 'Content-Type': 'application/json' },
//            success : delete_success,
//        });
//        function delete_success() {
//            alert('Deleted')
//        }
//		});
    //擦除
    $("#Erase").on('click', function () {
        if (isErasing){
            $(this).css("background-color","white");
            isErasing = false;

        }
        else{
            $(this).css("background-color","red")
            isErasing = true;

        }
    })
    //实时画图
    $(document).on('mousemove',function (e) {
        let r = line_width,x = e.pageX,y = e.pageY;
        let l = $('#origin').offsetLeft, ri = l+$("#origin").offsetWidth, t=$("#origin").offsetTop, b=t+$("#origin").offsetY;
        if( x < 1000 && x >20 && y < 1000 || y > 20){
            if(!isErasing) {
                    $("#arc").css({
                        "position": "absolute",
                        "left": e.pageX - line_width / 2,
                        "top": e.pageY - line_width / 2,
                        "z-index": "10000",
                        "width": line_width,
                        "height": line_width,
                        "border-radius": line_width / 2
                    });
            }
            else{
                    $("#arc").css({"position":"absolute","left":e.pageX-erase_r,"top":e.pageY-erase_r,"z-index":"10000",
                        "width":erase_r*2,"height":erase_r*2,"border-radius":erase_r});
            }
        }
    })

    $("canvas").on('mousemove', function (e) {
		if(!$(this).is("#labeling")){
			if(isDrawing && !$(this).is('#origin')) {
				x = e.offsetX;
				y = e.offsetY;
				let canvas = $(this).get(0), ctx = canvas.getContext('2d');
				if (!isErasing) {
					//原图
					ctx.lineWidth = line_width;
					ctx.lineCap = "round";
					ctx.lineJoin = "round";
					ctx.strokeStyle = $(this).attr("color");
					ctx.beginPath();
					ctx.moveTo(lastX, lastY);
					if(islev == true){
						ctx.lineTo(x, lastY);
						ctx.stroke();
						[lastX, lastY] = [x, lastY];
					}
					else if(islev == false) {
						ctx.lineTo(x, y);
						ctx.stroke();
						[lastX, lastY] = [x, y];
					}
				}
				else{
					clearArcFun(x,y,erase_r,ctx);
					// ctx_prev.clearRect(x,y,100,100);
				}
			}
		}
    });
    $(document).keydown(function(e) {
       if(e.keyCode == 32){
		   if(isIn){
			  		e.preventDefault();
		   			islev = true;
			  }
       }
    });
    $(document).keyup(function (e) {
        
        if(e.keyCode == 32){
			e.preventDefault();
            islev =false;
        }
    })
    function clearArcFun(x,y,r,ctx){
        let stepClear=1;
        clearArc(x,y,r);
        function clearArc(x,y,radius){
            let calcWidth=radius-stepClear;
            let calcHeight=Math.sqrt(radius*radius-calcWidth*calcWidth);

            let posX=x-calcWidth;
            let posY=y-calcHeight;

            let widthX=2*calcWidth;
            let heightY=2*calcHeight;

            if(stepClear<=radius){
                ctx.clearRect(posX,posY,widthX,heightY);
                stepClear+=1;
                clearArc(x,y,radius);
            }
        }
    }

    let Stack = [];
    document.oncontextmenu = function (event) {
        event.preventDefault();
    };
    // 切换tag状态
    $("canvas").on('mousedown ',  function(e){
        if(e.which==3){
            e.preventDefault();
            let check_layer = $(this).attr("id");
            e.preventDefault();
            Stack = [];
            let xi = e.offsetX, yi = e.offsetY;
            floodFill(xi, yi, check_layer);
            // if(!isTag) {
            //     console.log(isTag);
            //     floodFill(xi, yi, check_layer);
            //     isTag = true;
            // }
            // else{
            //     console.log(isTag);
            // floodFill(xi, yi, check_layer);
            // isTag = false;
            // }
        }
        // alert(e.which);
        else{
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

    });

    $("canvas").on('mouseup', function(){
        isDrawing = false;
    });

    $("canvas").on('mouseout', function(){
        isDrawing = false;
		isIn=false;
    });
	$("canvas").on('mouseenter',function(){
		isIn = true;
	})
    //剪裁尺寸
    $(document).mousewheel(function (e,delta) {
        if(!isErasing) {
            if (isDrawing) {
                e.preventDefault();
                let dir = delta > 0 ? 'Up' : 'Down';
                if (dir == 'Up') {
                    line_width += 3;
                } else {
                    line_width -= 3;
                }

            }
            $("#arc").css({"position":"absolute","left":e.pageX-line_width/2,"top":e.pageY-line_width/2,"z-index":"10000",
                "width":line_width,"height":line_width,"border-radius":line_width/2});
        }
        else{
            if (isDrawing) {
                e.preventDefault();
                let dir = delta > 0 ? 'Up' : 'Down';
                if (dir == 'Down' && erase_r>6) {
                    erase_r -= 3;
                } else {
                    erase_r += 3;
                }
            }
            $("#arc").css({"position":"absolute","left":e.pageX-erase_r,"top":e.pageY-erase_r,"z-index":"10000",
                "width":erase_r*2,"height":erase_r*2,"border-radius":erase_r});
        }
    });

    //flood fill
    // skip over some pixels, make things faster but can be incorrect
    let SKIP = 2, to_color=[];
    function floodFill(x, y,check_layer){
        // get the red canvas for now . . .
        let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
        // the list of stuff to be filled
        to_color = [];
        // the string hash of visited
        let visited = new Set([]);

        let frontier = [[x,y]];
        function close_to_red(a_color) {
            return Math.abs(a_color[3] - 255) < 10;
        }
        while (frontier.length > 0) {
            let cur_node = frontier.pop();
            // if the current node is not already in the set
            if (visited.has(String(cur_node)) == false) {
                visited.add(String(cur_node));
                let cur_x = cur_node[0];
                let cur_y = cur_node[1];

                let node_color = ctx.getImageData(cur_x, cur_y, 1, 1).data;
                //if ((node_color[0] == 255) && node_color[1] == 62) {
                if (close_to_red(node_color)) {
                    to_color.push([cur_x, cur_y]);
                    for (let i = -1; i < 2; i ++){
                        for (let j = -1; j < 2; j++){
                            let new_x = cur_x + i * SKIP;
                            let new_y = cur_y + j * SKIP;
                            frontier.push([new_x, new_y]);
                        }
                    }
                }
            }
            // console.log("frontier");
            // console.log(frontier);
            // console.log("visited");
            // console.log(visited);
        }

        // actually fill the stuff in the list
        if(to_color.length>10){
            for (let i = 0; i < to_color.length; i++) {
                let color_rgba = ctx.getImageData(to_color[i][0], to_color[i][1], 1, 1).data;
                console.log(color_rgba);
                if(color_rgba[0]==255||(color_rgba[1]<256&&color_rgba[1]>250)) {
                    fillColor(to_color[i][0], to_color[i][1], check_layer);
                }
                else{
                    fillWhite(to_color[i][0], to_color[i][1], check_layer);
                }
            }
        }
    }

    function fillWhite(x, y,check_layer){
        // this function will actually change the color of our box
        let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
        ctx.fillStyle = "white";
        ctx.fillRect(x - SKIP / 2 + 1, y - SKIP / 2 + 1, SKIP, SKIP);
    }
    function fillColor(x, y,check_layer) {
        let canvas = document.getElementById(check_layer), ctx = canvas.getContext("2d");
        let fillcolor = $("#"+check_layer).attr("color");
        ctx.fillStyle = fillcolor;
        ctx.fillRect(x - SKIP / 2 + 1, y - SKIP / 2 + 1, SKIP, SKIP);
    }
	
	//labeling
	
	//labeling信息记录
	let curRectArray=[],curPoint=[];
	function CopyCurPoint(a){
        return[a[0],a[1]];
    }
	function CopyCurRect(b){
		return[b[0],b[1],b[2],b[3]];
	}
	//逆时针计算
	function reArrange(l1, l2, l3, l4) {
		  let en = [];
		  let pn = [ [l1,0],[l2,1],[l3,2],[l4,3] ]
		  let pnb = pn.slice(0);
		  pn.sort((a,b) => { return a[0][0]-b[0][0]; });
		  if( pnb[pn[0][1]][0][1] < pnb[pn[1][1]][0][1]){
			en[0] = pnb[pn[0][1]][0]
			en[1] = pnb[pn[1][1]][0]
		  } else {
			en[0] = pnb[pn[1][1]][0]
			en[1] = pnb[pn[0][1]][0]
		  }

		  if( pnb[pn[2][1]][0][1] > pnb[pn[3][1]][0][1]){
			en[2] = pnb[pn[2][1]][0]
			en[3] = pnb[pn[3][1]][0]
		  } else {
			en[2] = pnb[pn[3][1]][0]
			en[3] = pnb[pn[2][1]][0]
		  }
		  return [ en[0],en[1],en[2],en[3] ]
		}
	//勾线function
	function renderLabeling(){
		console.log("111");
		let canvas_labeling = document.getElementById('labeling');
		let ctx = canvas_labeling.getContext('2d');
		ctx.clearRect(0, 0, 1000,2000);
		console.log(allDataArray);
		for(let i = 0; i<allDataArray.length;i++){
			ctx.beginPath();
			ctx.moveTo(allDataArray[i][0][0],allDataArray[i][0][1]);
			ctx.lineTo(allDataArray[i][1][0], allDataArray[i][1][1]);
			ctx.lineTo(allDataArray[i][2][0], allDataArray[i][2][1]);
			ctx.lineTo(allDataArray[i][3][0],allDataArray[i][3][1]);
			ctx.closePath();
			ctx.stroke();
			ctx.font = "12px '微软雅黑'";
			ctx.fillText(i+1,allDataArray[i][3][0],allDataArray[i][3][1]);
		} 
	}
	//创建dictionary
	function CreatUpLoadArray(){
		reginDic={};
		for (let i = 0; i<allDataArray.length;i++){
			reginDic[i] =allDataArray[i];
		}
		console.log(reginDic);
	}
	//勾线
	$("#labeling").on('click',function(e){
		curPoint[0] = e.offsetX;
		curPoint[1] = e.offsetY;
		if(curRectArray.length<3){
			let rectPoint = CopyCurPoint(curPoint);
			curRectArray.push(rectPoint);
		}else{
			let rectPoint = CopyCurPoint(curPoint);
			curRectArray.push(rectPoint);
			let rectArray = CopyCurRect(curRectArray);
			rectArray = reArrange(rectArray[0],rectArray[1],rectArray[2],rectArray[3]);
			allDataArray.push(rectArray);
			console.log(allDataArray);
			renderLabeling();
		 	curRectArray = [];
			CreatUpLoadArray();
		}
	});
	//撤回勾线
 $("#rollback").on('click',function(){
		allDataArray.pop();
		console.log(allDataArray);
		renderLabeling();
	 	CreatUpLoadArray();
	})
</script>
</html>